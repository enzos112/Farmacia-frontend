<div class="productos-container">
  <!-- Sección de búsqueda y filtros -->
  <div class="search-section" *ngIf="!mostrarCategorias && !mostrarUnidades">
    <div class="search-filters">
      <div class="filter-group">
        <label class="filter-label">Término de búsqueda</label>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar por nombre"
          [(ngModel)]="searchTerm">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">Filtrar por Stock</label>
        <select class="stock-filter" [(ngModel)]="stockFilter">
          <option value="">Todos</option>
          <option value="sin-stock">Sin Stock</option>
          <option value="stock-bajo">Stock Bajo</option>
          <option value="con-stock">Con Stock</option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="btn-buscar" (click)="buscarProductos()">
          <span class="icon-search"></span> Buscar
        </button>
        <button class="btn-limpiar" (click)="limpiarFiltros()">
          <span class="icon-clean"></span> Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Header con título y botones de acción -->
  <div class="productos-header">
    <h2 class="page-title">{{ pageTitle }}</h2>
    <div class="header-actions">
      <button class="btn-reporte-stock" (click)="reporteStockBajo()">
        <span class="icon-warning"></span> Reporte Stock Bajo
      </button>
      <button class="btn-nuevo-producto" (click)="nuevoProducto()">
        <span class="icon-add"></span> Nuevo Producto
      </button>
      <button class="btn-categorias" (click)="verCategorias()">
        <span class="icon-category"></span> Categorías
      </button>
      <button class="btn-unidades-medida" (click)="verUnidadesMedida()">
        <span class="icon-units"></span> Unidades de Medida
      </button>
    </div>
  </div>

  <!-- Botón debajo del título cuando estamos en Categorías -->
  <div class="sub-actions" *ngIf="mostrarCategorias">
    <button class="btn-nueva-categoria" (click)="nuevoCategoria()">
      <span class="icon-add"></span> Nueva Categoría
    </button>
    <button class="btn-ver-productos" (click)="verProductos()">
      <span class="icon-list"></span> Lista de Productos
    </button>
  </div>

  <!-- Botón debajo del título cuando estamos en Unidades de Medida -->
  <div class="sub-actions" *ngIf="mostrarUnidades">
    <button class="btn-nueva-unidad" (click)="nuevaUnidad()">
      <span class="icon-add"></span> Crear Nueva Unidad
    </button>
    <button class="btn-ver-productos" (click)="verProductos()">
      <span class="icon-list"></span> Lista de Productos
    </button>
  </div>

  <!-- Tabla de productos -->
  <div class="productos-table-container" *ngIf="!mostrarCategorias && !mostrarUnidades">
    <table class="productos-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Stock</th>
          <th>Precio</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let producto of productosFiltrados" class="producto-row">
          <td class="producto-nombre" data-label="Nombre">{{ producto.nombre }}</td>
          <td class="producto-categoria" data-label="Categoría">{{ getCategoria(producto) }}</td>
          <td class="producto-stock" data-label="Stock" [ngClass]="getStockClass(producto.stock)">
            {{ producto.stock.toFixed(2) }}
          </td>
          <td class="producto-precio" data-label="Precio">${{ producto.precioVenta.toFixed(2) }}</td>
          <td class="producto-acciones" data-label="Acciones">
            <button class="btn-accion btn-editar" (click)="editarProducto(producto)" title="Editar">
              Editar
            </button>
            <button class="btn-accion btn-eliminar" (click)="eliminarProducto(producto)" title="Eliminar">
              Eliminar
            </button>
          </td>
        </tr>
        <tr *ngIf="productosFiltrados.length === 0">
          <td colspan="5" class="no-productos">
            No se encontraron productos
          </td>
        </tr>
        <tr *ngIf="isLoading">
          <td colspan="5" class="loading-productos">
            <div class="spinner"></div> Cargando productos...
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Tabla de Categorías -->
  <div class="productos-table-container" *ngIf="mostrarCategorias">
    <table class="productos-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cat of categoriasGestion">
          <td class="producto-nombre" data-label="Nombre">{{ cat.nombre }}</td>
          <td class="producto-acciones" data-label="Acciones">
            <button class="btn-accion btn-editar" (click)="editarCategoria(cat)" title="Editar">
              Editar
            </button>
            <button class="btn-accion btn-eliminar" (click)="eliminarCategoria(cat)" title="Eliminar">
              Eliminar
            </button>
          </td>
        </tr>
        <tr *ngIf="categoriasGestion.length === 0">
          <td colspan="2" class="no-productos">No hay categorías registradas</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Tabla de Unidades de Medida -->
  <div class="productos-table-container" *ngIf="mostrarUnidades">
    <table class="productos-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Símbolo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of unidadesGestion">
          <td class="producto-nombre" data-label="Nombre">{{ u.nombre }}</td>
          <td class="producto-categoria" data-label="Símbolo">{{ u.simbolo }}</td>
          <td class="producto-acciones" data-label="Acciones">
            <button class="btn-accion btn-editar" (click)="editarUnidad(u)" title="Editar">
              Editar
            </button>
            <button class="btn-accion btn-eliminar" (click)="eliminarUnidad(u)" title="Eliminar">
              Eliminar
            </button>
          </td>
        </tr>
        <tr *ngIf="unidadesGestion.length === 0">
          <td colspan="3" class="no-productos">No hay unidades registradas</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal para Crear/Editar Producto -->
  <div class="modal-overlay" *ngIf="showModal" (click)="cerrarModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{ modoEdicion ? 'Editar Producto' : 'Crear Producto' }}</h2>
        <button class="btn-close" (click)="cerrarModal()">✕</button>
      </div>

      <div class="modal-body">
        <form class="producto-form">
          <!-- Fila 1: Nombre -->
          <div class="form-row">
            <div class="form-group full-width">
              <label class="form-label">Nombre del Producto *</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="productoForm.nombre"
                name="nombre"
                placeholder="Ej: Paracetamol 500mg"
                required>
            </div>
          </div>

          <!-- Fila 2: Descripción -->
          <div class="form-row">
            <div class="form-group full-width">
              <label class="form-label">Descripción</label>
              <textarea 
                class="form-control form-textarea" 
                [(ngModel)]="productoForm.descripcion"
                name="descripcion"
                rows="2"
                placeholder=""></textarea>
            </div>
          </div>

          <!-- Fila 3: Categoría y Unidad de Medida -->
          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label">Categoría</label>
              <select 
                class="form-control" 
                [(ngModel)]="productoForm.categoria"
                name="categoria">
                <option value="">-- Seleccione Categoría --</option>
                <option *ngFor="let cat of categoriasGestion" [value]="cat.nombre">{{ cat.nombre }}</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidad de Medida</label>
              <select 
                class="form-control" 
                [(ngModel)]="productoForm.unidadMedida"
                name="unidadMedida">
                <option value="">-- Seleccione Unidad --</option>
                <option value="Caja">Caja</option>
                <option value="Frasco">Frasco</option>
                <option value="Paquete">Paquete</option>
                <option value="Tabletas">Tabletas</option>
                <option value="Tubo">Tubo</option>
                <option value="Unidad">Unidad</option>
              </select>
            </div>
          </div>

          <!-- Fila 4: Laboratorio, Presentación y Ubicación -->
          <div class="form-row three-cols">
            <div class="form-group">
              <label class="form-label">Laboratorio</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="productoForm.laboratorio"
                name="laboratorio"
                placeholder="">
            </div>
            <div class="form-group">
              <label class="form-label">Presentación</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="productoForm.presentacion"
                name="presentacion"
                placeholder="">
            </div>
            <div class="form-group">
              <label class="form-label">Ubicación</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="productoForm.ubicacion"
                name="ubicacion"
                placeholder="">
            </div>
          </div>

          <!-- Fila 5: Precios -->
          <div class="form-row three-cols">
            <div class="form-group">
              <label class="form-label">Precio al por Menor</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="productoForm.precioCompra"
                name="precioCompra"
                step="0.01"
                placeholder="0.00">
            </div>
            <div class="form-group">
              <label class="form-label">Precio de Compra</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="productoForm.precioVenta"
                name="precioVenta"
                step="0.01"
                placeholder="0.00">
            </div>
            <div class="form-group">
              <label class="form-label">Precio al por Mayor</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="productoForm.precioMayor"
                name="precioMayor"
                step="0.01"
                placeholder="0.00">
            </div>
          </div>

          <!-- Fila 6: Stock, Stock Mínimo y Fecha de Vencimiento -->
          <div class="form-row three-cols">
            <div class="form-group">
              <label class="form-label">Stock</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="productoForm.stock"
                name="stock"
                placeholder="0.00">
            </div>
            <div class="form-group">
              <label class="form-label">Stock Mínimo</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="productoForm.stockMinimo"
                name="stockMinimo"
                placeholder="0.00">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha de Vencimiento</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="productoForm.fechaVencimiento"
                name="fechaVencimiento"
                placeholder="dd/mm/aaaa">
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-guardar" (click)="guardarProducto()">
           Guardar Producto
        </button>
                <button class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Reporte de Stock Bajo -->
  <div class="modal-overlay" *ngIf="showReporteModal" (click)="cerrarReporteModal()">
    <div class="modal-container modal-reporte" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="icon-warning-title"></span> Reporte de Stock Bajo
        </h2>
        <button class="btn-close" (click)="cerrarReporteModal()">✕</button>
      </div>

      <div class="modal-body">
        <div class="reporte-summary">
          <div class="summary-card card-critico">
            <div class="summary-icon"></div>
            <div class="summary-info">
              <div class="summary-number">{{ productosSinStock.length }}</div>
              <div class="summary-label">Sin Stock</div>
            </div>
          </div>
          <div class="summary-card card-alerta">
            <div class="summary-icon"></div>
            <div class="summary-info">
              <div class="summary-number">{{ productosStockBajo.length }}</div>
              <div class="summary-label">Stock Bajo</div>
            </div>
          </div>
          <div class="summary-card card-total">
            <div class="summary-icon"></div>
            <div class="summary-info">
              <div class="summary-number">{{ productosSinStock.length + productosStockBajo.length }}</div>
              <div class="summary-label">Total a Reabastecer</div>
            </div>
          </div>
        </div>

        <!-- Productos sin stock -->
        <div class="reporte-section" *ngIf="productosSinStock.length > 0">
          <div class="section-header sin-stock-header">
            <h3> Productos sin Stock ({{ productosSinStock.length }})</h3>
          </div>
          <div class="reporte-table-container">
            <table class="reporte-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nombre del Producto</th>
                  <th>Stock</th>
                  <th>Precio</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of productosSinStock; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td class="producto-nombre">{{ producto.nombre }}</td>
                  <td class="stock-cero">{{ producto.stock }}</td>
                  <td class="producto-precio">${{ producto.precioVenta.toFixed(2) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="reporte-section" *ngIf="productosSinStock.length === 0">
          <div class="section-header success-header">
            <h3> No hay productos sin stock</h3>
          </div>
        </div>

        <!-- Productos con stock bajo -->
        <div class="reporte-section" *ngIf="productosStockBajo.length > 0">
          <div class="section-header stock-bajo-header">
            <h3> Productos con Stock Bajo ({{ productosStockBajo.length }})</h3>
          </div>
          <div class="reporte-table-container">
            <table class="reporte-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nombre del Producto</th>
                  <th>Stock Actual</th>
                  <th>Precio</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of productosStockBajo; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td class="producto-nombre">{{ producto.nombre }}</td>
                  <td class="stock-bajo">{{ producto.stock }} unidades</td>
                  <td class="producto-precio">${{ producto.precioVenta.toFixed(2) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="reporte-section" *ngIf="productosStockBajo.length === 0">
          <div class="section-header success-header">
            <h3> No hay productos con stock bajo</h3>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button 
          class="btn-filtrar" 
          (click)="filtrarStockBajo()"
          *ngIf="productosSinStock.length > 0 || productosStockBajo.length > 0">
          <span class="icon-filter"></span> Filtrar Productos con Stock Bajo
        </button>
        <button class="btn-cancelar" (click)="cerrarReporteModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Nueva/Editar Categoría -->
  <div class="modal-overlay" *ngIf="showCategoriaModal" (click)="cerrarCategoriaModal()">
    <div class="modal-container modal-simple" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{ modoEdicionCategoria ? 'Editar Categoría' : 'Nueva Categoría' }}</h2>
        <button class="btn-close" (click)="cerrarCategoriaModal()">✕</button>
      </div>

      <div class="modal-body">
        <form class="simple-form">
          <div class="form-group">
            <label class="form-label">Nombre de la Categoría *</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="categoriaForm.nombre"
              name="nombreCategoria"
              placeholder="Ej: Analgésicos"
              required
              autofocus>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-guardar" (click)="guardarCategoria()">
          {{ modoEdicionCategoria ? 'Actualizar' : 'Guardar' }}
        </button>
        <button class="btn-cancelar" (click)="cerrarCategoriaModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Nueva/Editar Unidad de Medida -->
  <div class="modal-overlay" *ngIf="showUnidadModal" (click)="cerrarUnidadModal()">
    <div class="modal-container modal-simple" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{ modoEdicionUnidad ? 'Editar Unidad de Medida' : 'Nueva Unidad de Medida' }}</h2>
        <button class="btn-close" (click)="cerrarUnidadModal()">✕</button>
      </div>

      <div class="modal-body">
        <form class="simple-form">
          <div class="form-group">
            <label class="form-label">Nombre de la Unidad *</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="unidadForm.nombre"
              name="nombreUnidad"
              placeholder="Ej: Caja"
              required
              autofocus>
          </div>
          <div class="form-group">
            <label class="form-label">Símbolo (Abreviatura) *</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="unidadForm.simbolo"
              name="simboloUnidad"
              placeholder="Ej: CAJA"
              required
              maxlength="10"
              style="text-transform: uppercase;">
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-guardar" (click)="guardarUnidad()">
          {{ modoEdicionUnidad ? 'Actualizar' : 'Guardar' }}
        </button>
        <button class="btn-cancelar" (click)="cerrarUnidadModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Alerta -->
<div class="alert-overlay" *ngIf="showAlertModal" (click)="cerrarAlerta()">
  <div class="modal-content modal-alert" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ alertTitle }}</h2>
      <button class="btn-close" (click)="cerrarAlerta()">&times;</button>
    </div>

    <div class="modal-body">
      <p class="alert-message">{{ alertMessage }}</p>
    </div>

    <div class="modal-footer">
      <button class="btn-primary" (click)="cerrarAlerta()">Aceptar</button>
    </div>
  </div>
</div>
